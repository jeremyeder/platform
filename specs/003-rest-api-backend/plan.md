# Implementation Plan: REST API Backend for ACP Mobile App

**Branch**: `003-rest-api-backend` | **Date**: 2025-12-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-rest-api-backend/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Build a REST API Backend in the platform repository (`~/repos/platform/components/backend`) to serve the ACP Mobile app. The backend will extend the existing Go + Gin architecture with mobile-friendly endpoints for session management, Server-Sent Events (SSE) for real-time updates, GitHub notifications integration, and user preferences management. All responses MUST match mobile app Zod schemas exactly (source of truth: `~/repos/mobile/services/api/schemas.ts`).

**Primary Approach**: Reuse existing Kubernetes Custom Resources (AgenticSession CRD) with a transformation layer to mobile JSON schemas. Implement SSE using Gin's native streaming. Leverage existing GitHub App infrastructure for notifications. Follow ADR-0002 (User Token Authentication) for all mobile endpoints.

**Implementation Repository**: `~/repos/platform/components/backend` (Go + Gin)
**Consumer Repository**: `~/repos/mobile` (React Native + Expo)

---

## Technical Context

**Language/Version**: Go 1.24.0
**Primary Dependencies**: Gin v1.10.1 (web framework), k8s.io/client-go v0.34.0 (Kubernetes), github.com/golang-jwt/jwt/v5 v5.3.0 (JWT), github.com/gorilla/websocket v1.5.4 (WebSocket - for SSE pattern reference)
**Storage**: Kubernetes Custom Resource Definitions (AgenticSession, UserPreferences CRD, PushToken CRD) - no traditional database
**Testing**: Go standard testing, table-driven tests with subtests, integration tests require TEST_NAMESPACE env var
**Target Platform**: Kubernetes (OpenShift) - deployed as part of existing backend service
**Project Type**: Backend API (extends existing platform backend)
**Performance Goals**: <2 seconds API response (95th percentile), <2 seconds SSE event latency, 100+ concurrent SSE connections per instance
**Constraints**: Responses MUST match mobile Zod schemas exactly (case-sensitive enums, ISO 8601 dates, exact field names), User token authentication required (ADR-0002), No service account for user operations
**Scale/Scope**: 100+ concurrent mobile users, 5 API endpoint groups (sessions, SSE, notifications, repositories, user/auth), Real-time updates via SSE

---

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

**Status**: ✅ PASS (Constitution file is empty template - no violations)

**Note**: The platform backend follows its own development conventions documented in `~/repos/platform/CLAUDE.md` and ADRs. This implementation will follow existing patterns:
- User token authentication (ADR-0002)
- Kubernetes CRD storage
- Gin HTTP framework
- Structured error responses

No constitution violations detected as no constitution has been established for this project.

---

## Project Structure

### Documentation (this feature)

```text
specs/003-rest-api-backend/
├── plan.md              # This file (/speckit.plan command output)
├── spec.md              # Business requirements (created by /speckit.specify)
├── checklists/
│   └── requirements.md  # Validation checklist (created by /speckit.specify)
├── research.md          # Phase 0 output (/speckit.plan command) ✅ COMPLETE
├── data-model.md        # Phase 1 output (/speckit.plan command) ✅ COMPLETE
├── quickstart.md        # Phase 1 output (/speckit.plan command) ✅ COMPLETE
├── contracts/           # Phase 1 output (/speckit.plan command) ✅ COMPLETE
│   └── openapi.yaml     # OpenAPI 3.1 specification
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (platform repository)

**Location**: `~/repos/platform/components/backend`

```text
components/backend/
├── handlers/                   # HTTP request handlers
│   ├── mobile_sessions.go      # ⚠️ NEW: Mobile session endpoints
│   ├── mobile_sse.go           # ⚠️ NEW: SSE streaming endpoint
│   ├── mobile_notifications.go # ⚠️ NEW: GitHub notifications
│   ├── mobile_user.go          # ⚠️ NEW: User profile & preferences
│   ├── mobile_auth.go          # ⚠️ NEW: OAuth 2.0 + PKCE
│   ├── sessions.go             # EXISTING: AgenticSession lifecycle (reference)
│   ├── middleware.go           # EXISTING: Auth middleware (GetK8sClientsForRequest)
│   └── helpers.go              # EXISTING: Utility functions
├── sse/                        # ⚠️ NEW: SSE hub package
│   └── hub.go                  # SSE connection manager
├── github/                     # EXISTING: GitHub App integration
│   ├── app.go                  # EXISTING: Installation management
│   ├── token.go                # EXISTING: Token minting
│   └── notifications.go        # ⚠️ NEW: Notification transformation
├── types/                      # Type definitions
│   ├── mobile.go               # ⚠️ NEW: Mobile response types
│   ├── session.go              # EXISTING: AgenticSession types
│   └── common.go               # EXISTING: Shared types
├── k8s/                        # EXISTING: Kubernetes operations
│   ├── resources.go            # EXISTING: GVR definitions
│   └── userprefs.go            # ⚠️ NEW: UserPreferences CRD operations
├── server/                     # EXISTING: Server setup
│   └── server.go               # EXISTING: HTTP server (may need CORS update)
├── tests/
│   ├── mobile_api_test.go      # ⚠️ NEW: Mobile endpoint tests
│   ├── sse_test.go             # ⚠️ NEW: SSE tests
│   └── integration/            # EXISTING: K8s integration tests
├── routes.go                   # ⚠️ UPDATE: Register mobile API routes
├── main.go                     # EXISTING: Entry point (no changes)
├── go.mod                      # EXISTING: Dependencies (may add SSE libs)
└── README.md                   # EXISTING: Development docs
```

### Mobile App Consumer (reference only)

**Location**: `~/repos/mobile` (React Native + Expo)

```text
mobile/
├── services/
│   ├── api/
│   │   ├── schemas.ts          # ⚠️ CRITICAL: Zod schemas (source of truth)
│   │   ├── client.ts           # HTTP client with auth interceptors
│   │   ├── sessions.ts         # Sessions API client
│   │   ├── notifications.ts    # Notifications API client
│   │   └── realtime.ts         # SSE client
│   ├── auth/
│   │   ├── oauth.ts            # OAuth 2.0 + PKCE implementation
│   │   └── token-manager.ts    # Token storage & refresh
├── hooks/
│   ├── useRealtimeSession.ts   # SSE → React Query cache sync
│   └── useAuth.tsx             # Auth context provider
└── types/
    ├── session.ts              # TypeScript interfaces
    ├── notification.ts         # Notification types
    └── realtime.ts             # SSE event types
```

**Structure Decision**: This feature implements backend APIs in the **platform repository** (`~/repos/platform/components/backend`) to serve the **mobile repository** (`~/repos/mobile`). The mobile app is the consumer and defines the API contract via Zod schemas in `services/api/schemas.ts`. Backend implementation MUST match these schemas exactly (case-sensitive enums, ISO 8601 dates, exact field names).

---

## Complexity Tracking

**No Constitution Violations** - This section is left empty as the constitution check passed.

---

## Design Artifacts Generated

All Phase 0 (Research) and Phase 1 (Design) artifacts have been completed:

### Phase 0: Research ✅

**File**: [`research.md`](./research.md)

**Key Decisions**:
1. **Backend Stack**: Go 1.24.0 + Gin v1.10.1 (extend existing platform backend)
2. **Authentication**: OAuth 2.0 + PKCE with JWT tokens (ADR-0002 pattern)
3. **Storage**: Kubernetes CRDs (AgenticSession, UserPreferences, PushToken) - no separate database
4. **Real-time**: Server-Sent Events (SSE) using Gin's native streaming
5. **GitHub Integration**: Extend existing GitHub App infrastructure
6. **API Contract**: Mobile Zod schemas are source of truth (`~/repos/mobile/services/api/schemas.ts`)
7. **Error Handling**: Standardized ErrorResponse struct matching mobile expectations
8. **Security**: Follow existing token redaction, RBAC enforcement, input validation patterns

**Critical Open Questions Resolved**:
- ⚠️ **Repository ID vs URL**: Mobile app sends `repositoryId` but labels it `repositoryUrl`. Backend must clarify if it expects ID or full GitHub URL. **Action**: Document in API contracts and verify during implementation.
- **User Preferences Storage**: Use UserPreferences CRD (consistent with platform patterns)
- **Push Tokens Storage**: Use PushToken CRD (K8s-native, namespace per user)

### Phase 1: Design ✅

**Files Created**:

1. **[`data-model.md`](./data-model.md)** - Complete entity definitions
   - **Entities**: User, Session, Repository, Notification, UserPreferences, PushToken
   - **Kubernetes Mapping**: Detailed transformation from AgenticSession CRD to mobile JSON
   - **Validation Rules**: Kubernetes DNS-1123 labels, enum values, date formats
   - **State Transitions**: Session status lifecycle diagram

2. **[`contracts/openapi.yaml`](./contracts/openapi.yaml)** - OpenAPI 3.1 specification
   - **Endpoints**: 18 endpoints across 6 groups (sessions, SSE, notifications, repositories, user, auth)
   - **Schemas**: Complete request/response schemas matching mobile Zod
   - **Authentication**: Bearer token security scheme
   - **Examples**: SSE event formats, error responses

3. **[`quickstart.md`](./quickstart.md)** - Backend developer guide
   - **Phase 1**: Sessions API implementation (Week 1)
   - **Phase 2**: Server-Sent Events (Week 1-2)
   - **Phase 3**: GitHub Notifications (Week 2)
   - **Code Examples**: Complete handlers, SSE hub, transformation functions
   - **Testing Checklist**: Unit, integration, mobile app tests
   - **Debugging Guide**: Common issues and solutions

---

## Implementation Phases

### Phase 0: Research ✅ COMPLETE

**Status**: ✅ All unknowns resolved

**Outputs**:
- [`research.md`](./research.md) - Technology decisions, architecture patterns, security measures

**Key Findings**:
- Backend infrastructure 90% complete (existing Go + Gin + K8s CRDs)
- Mobile app has complete Zod schemas defining exact API contract
- SSE feasible using Gin's native streaming (similar to existing WebSocket patterns)
- GitHub App infrastructure ready for notification integration

---

### Phase 1: Design ✅ COMPLETE

**Status**: ✅ All design artifacts generated

**Outputs**:
- [`data-model.md`](./data-model.md) - Entity definitions and K8s mapping
- [`contracts/openapi.yaml`](./contracts/openapi.yaml) - API contract (OpenAPI 3.1)
- [`quickstart.md`](./quickstart.md) - Implementation guide for backend developers
- `CLAUDE.md` updated with technologies (via `update-agent-context.sh`)

**Constitution Re-Check**: ✅ PASS (no violations)

---

### Phase 2: Task Generation (Not Executed)

**Status**: ⏸️ Not executed by `/speckit.plan` command

**Next Step**: Run `/speckit.tasks` to generate `tasks.md`

**Expected Output**: Dependency-ordered task list with:
- Task descriptions (imperative form: "Implement X")
- Active forms (present continuous: "Implementing X")
- Dependencies between tasks
- Acceptance criteria per task
- Estimated complexity (T-shirt sizes)

---

## Critical Implementation Notes

### 1. Mobile Zod Schema Contract (CRITICAL)

**Source of Truth**: `~/repos/mobile/services/api/schemas.ts`

**MUST Match Exactly**:
- **Enum Values**: Case-sensitive (e.g., `"running"` NOT `"RUNNING"`)
  - SessionStatus: `running | paused | done | awaiting_review | error`
  - ModelType: `sonnet-4.5 | opus-4.5`
- **Date Format**: ISO 8601 strings (e.g., `"2025-12-07T10:00:00Z"`)
  - Use `time.RFC3339` in Go
  - NEVER use Unix timestamps
- **Field Names**: Exact matches (e.g., `createdAt` NOT `created_at`)
- **Nullability**: Respect `nullable: true` fields (e.g., `currentTask`, `errorMessage`)

**Validation**: Mobile app will crash if responses don't match Zod schemas.

---

### 2. Authentication Pattern (CRITICAL)

**Follow ADR-0002**: User Token Authentication

**ALWAYS Use**:
```go
reqK8s, reqDyn := GetK8sClientsForRequest(c)
if reqK8s == nil {
    c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid or missing token"})
    c.Abort()
    return
}
```

**NEVER Use** service account for user-initiated operations.

---

### 3. SSE Implementation

**Event Types**:
- `session.progress`: Progress updates (0-100) without full cache invalidation
- `session.status`: Status changes (running → awaiting_review)
- `session.updated`: Partial session updates (merge into cache)
- `notification.new`: New GitHub notifications
- `notification.read`: Notification marked as read

**Connection Management**:
- Heartbeat every 30 seconds (`: ping\n\n`)
- Support multiple connections per user
- Auto-cleanup on disconnect
- Exponential backoff on client side (mobile handles this)

---

### 4. Error Response Format

**Standardized Structure**:
```go
type ErrorResponse struct {
    Error      string      `json:"error"`       // "VALIDATION_ERROR"
    Message    string      `json:"message"`     // Human-readable
    StatusCode int         `json:"statusCode"`  // HTTP status
    Details    interface{} `json:"details,omitempty"` // Optional context
}
```

---

### 5. GitHub Notifications

**Workflow Suggestions**:
| Notification Type | Suggested Workflow |
|-------------------|-------------------|
| `PullRequest` | `review` |
| `Issue` (bug label) | `bugfix` |
| `Issue` (feature label) | `plan` |
| `Issue` (general) | `chat` |
| `Mention` | `chat` |

**Real-time Updates**: Poll GitHub every 5 minutes, send SSE event on new notifications

---

## Files Reference

### Critical Mobile Files (Must Read)
- `~/repos/mobile/services/api/schemas.ts` - **CRITICAL**: Zod schemas (source of truth)
- `~/repos/mobile/services/api/client.ts` - HTTP client with auth interceptors
- `~/repos/mobile/services/api/realtime.ts` - SSE client implementation
- `~/repos/mobile/hooks/useRealtimeSession.ts` - SSE → React Query cache sync

### Critical Backend Files
- `~/repos/platform/components/backend/handlers/sessions.go` - Existing session handlers
- `~/repos/platform/docs/adr/0002-user-token-authentication.md` - Auth pattern
- `~/repos/platform/components/backend/routes.go` - Route registration
- `~/repos/platform/components/backend/handlers/middleware.go` - Auth middleware

### Design Artifacts (This Spec)
- [`spec.md`](./spec.md) - Business requirements (50 functional requirements, 10 success criteria)
- [`research.md`](./research.md) - Technology decisions and architecture patterns
- [`data-model.md`](./data-model.md) - Entity definitions and K8s mapping
- [`contracts/openapi.yaml`](./contracts/openapi.yaml) - OpenAPI 3.1 specification
- [`quickstart.md`](./quickstart.md) - Implementation guide with code examples

---

## Next Steps

### For Backend Developers

1. **Read Critical Files**:
   - ✅ Mobile Zod schemas: `~/repos/mobile/services/api/schemas.ts`
   - ✅ ADR-0002: `~/repos/platform/docs/adr/0002-user-token-authentication.md`
   - ✅ Quickstart guide: [`quickstart.md`](./quickstart.md)

2. **Start Implementation** (3 phases):
   - **Phase 1** (Week 1): Sessions API (list, get, create, update)
   - **Phase 2** (Week 1-2): Server-Sent Events (SSE hub + streaming endpoint)
   - **Phase 3** (Week 2): GitHub Notifications (fetch, mark read, mute)

3. **Generate Task List**:
   - Run `/speckit.tasks` to create dependency-ordered task list
   - Tasks will reference quickstart guide examples

4. **Test with Mobile App**:
   - Configure `.env.local` to point to backend
   - Disable mock data (`EXPO_PUBLIC_USE_MOCK_DATA=false`)
   - Verify Zod validation passes (no console errors)

---

## Timeline Estimate

**MVP (Sessions + SSE + Notifications)**: 2-3 weeks

**Breakdown**:
- Week 1: Sessions API + SSE endpoint
- Week 2: GitHub Notifications + User Preferences
- Week 3: Testing, debugging, refinement

**Post-MVP**:
- OAuth 2.0 + PKCE (optional - mock auth works for internal testing)
- Push Notifications via Expo Push Service
- Repository management endpoints

---

## Success Criteria

**Technical**:
- ✅ All responses match mobile Zod schemas (zero validation errors)
- ✅ API response time <2 seconds (95th percentile)
- ✅ SSE event latency <2 seconds
- ✅ 100+ concurrent SSE connections supported
- ✅ User token authentication enforced (ADR-0002)

**User Experience**:
- ✅ Sessions list loads in mobile app
- ✅ Real-time progress updates appear without refresh
- ✅ GitHub notifications display with workflow suggestions
- ✅ Token refresh works automatically (401 handling)

**Quality**:
- ✅ No schema validation errors in production
- ✅ Comprehensive tests (unit + integration)
- ✅ Code follows existing platform patterns

---

**Plan Status**: ✅ COMPLETE
**Ready for**: `/speckit.tasks` to generate implementation task list
**Implementation Repository**: `~/repos/platform/components/backend`
**Consumer Repository**: `~/repos/mobile`
