# Langfuse Helm Chart Deployment - POC

## Overview

This POC validates the official Langfuse Helm chart deployment on Kubernetes (kind) and OpenShift environments. The approach uses the upstream Helm chart as designed by Langfuse maintainers with minimal customization to ensure compatibility and maintainability.

## What is Langfuse?

Langfuse is an open-source LLM observability and analytics platform that provides:
- Trace and debug LLM applications
- Analyze cost, latency, and quality metrics
- Collect user feedback and scores
- Dataset management for testing and evaluation

## Architecture

The Helm chart deploys a complete Langfuse stack:

```
┌─────────────────────────────────────────┐
│          Ingress/Route                  │
│      (langfuse.local)                   │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴────────┐
       │ Langfuse Web   │  (UI/API)
       │ Langfuse Worker│  (Background jobs)
       └───────┬────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐ ┌───▼──────┐ ┌─▼────┐
│PostgreSQL│ ClickHouse│ │Redis │
│ (Config) │ (Analytics)│ (Cache)│
└─────────┘ └──────────┘ └──────┘
```

**Components:**
- **Langfuse Web**: NextJS application (UI + API)
- **Langfuse Worker**: Background job processor
- **PostgreSQL**: Application database (user data, projects, metadata)
- **ClickHouse**: Analytics database (traces, observations, events)
- **Redis**: Cache and job queue
- **ZooKeeper**: Coordination for ClickHouse
- **MinIO**: S3-compatible object storage

## Prerequisites

### Software Requirements

- **Helm 3.x**: `brew install helm`
- **kubectl**: `brew install kubectl`
- **kind** (for Kubernetes): `brew install kind`
- **oc** (for OpenShift): Download from Red Hat
- **Docker or Podman**: Container runtime

### Resource Requirements

**Minimum for local testing:**
- CPU: 9 cores
- Memory: 19.5 GB RAM
- Disk: 50 GB

**Recommended for development:**
- CPU: 12+ cores
- Memory: 24+ GB RAM
- Disk: 100+ GB

### Cluster Requirements

**Kubernetes (kind):**
- kind cluster with ingress-nginx controller
- Use the existing `e2e/scripts/setup-kind.sh` script

**OpenShift:**
- CRC (local) or ROSA (production)
- Cluster admin access for SCC configuration
- Available StorageClass for PVCs

## Quick Start - Kubernetes (kind)

### Step 1: Setup kind Cluster

```bash
cd e2e
./scripts/setup-kind.sh
```

This creates a kind cluster named `vteam-e2e` with ingress support.

### Step 2: Deploy Langfuse

```bash
./scripts/deploy-langfuse-kind.sh
```

The script will:
- ✅ Check prerequisites (helm, kubectl, kind cluster)
- ✅ Generate secure secrets automatically
- ✅ Add Langfuse Helm repository
- ✅ Install Langfuse with kind-optimized configuration
- ✅ Wait for all pods to be ready
- ✅ Add `langfuse.local` to `/etc/hosts`
- ✅ Save credentials to `e2e/.env.langfuse`

### Step 3: Access Langfuse

Open your browser to:

```
http://langfuse.local:8080
```

**Note**: Port 8080 is used for Podman rootless compatibility. If using Docker, the URL is `http://langfuse.local` (port 80).

You should see the Langfuse login/signup page.

### Step 4: Validate Deployment

```bash
# Check pod status
kubectl get pods -n langfuse

# Expected output:
# NAME                              READY   STATUS    RESTARTS
# langfuse-web-xxx                  1/1     Running   0
# langfuse-worker-xxx               1/1     Running   0
# langfuse-postgresql-0             1/1     Running   0
# langfuse-clickhouse-xxx           1/1     Running   0
# langfuse-redis-master-0           1/1     Running   0
# langfuse-zookeeper-0              1/1     Running   0
# langfuse-minio-xxx                1/1     Running   0

# Check services
kubectl get svc -n langfuse

# Check ingress
kubectl get ingress -n langfuse

# View Langfuse logs
kubectl logs -n langfuse -l app.kubernetes.io/name=langfuse --tail=50
```

### Step 5: Cleanup

When done testing:

```bash
kubectl delete namespace langfuse
```

To remove `langfuse.local` from `/etc/hosts`:

```bash
sudo sed -i.bak '/langfuse.local/d' /etc/hosts
```

## Using the Makefile (Alternative)

Add this target to the main `Makefile`:

```makefile
deploy-langfuse-kind: ## Deploy Langfuse to kind cluster
	@cd e2e && ./scripts/deploy-langfuse-kind.sh
```

Then run:

```bash
make deploy-langfuse-kind
```

## Configuration Details

### Helm Chart Information

- **Repository**: https://langfuse.github.io/langfuse-k8s
- **Chart Name**: `langfuse/langfuse`
- **Version**: 1.5.9 (latest as of deployment)
- **Source Code**: https://github.com/langfuse/langfuse-k8s
- **Documentation**: https://langfuse.com/docs/deployment/self-host

### Default Values Used

The deployment script configures:

```yaml
langfuse:
  nextauth:
    secret: <auto-generated>  # Session encryption
  salt: <auto-generated>       # API key hashing

postgresql:
  enabled: true
  auth:
    password: <auto-generated>

clickhouse:
  enabled: true
  auth:
    password: <auto-generated>

redis:
  enabled: true
  auth:
    password: <auto-generated>

ingress:
  enabled: true
  className: nginx
  hosts:
    - host: langfuse.local
      paths:
        - path: /
          pathType: Prefix

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi
```

### Credentials Storage

All generated secrets are saved to `e2e/.env.langfuse`:

```bash
# View saved credentials
cat e2e/.env.langfuse
```

**Important**: This file contains sensitive credentials. Never commit it to version control.

## Troubleshooting

### Issue: Pods not starting

**Check pod status:**
```bash
kubectl get pods -n langfuse
kubectl describe pod -n langfuse <pod-name>
```

**Common causes:**
- Insufficient resources (CPU/memory)
- Image pull failures
- PVC binding issues

**Solution:**
```bash
# Check events
kubectl get events -n langfuse --sort-by='.lastTimestamp'

# Check resource usage
kubectl top nodes
```

### Issue: Ingress not accessible

**Verify ingress controller:**
```bash
kubectl get pods -n ingress-nginx
```

**Check ingress configuration:**
```bash
kubectl get ingress -n langfuse -o yaml
```

**Verify /etc/hosts:**
```bash
cat /etc/hosts | grep langfuse
```

### Issue: Database connection errors

**Check PostgreSQL pod:**
```bash
kubectl logs -n langfuse langfuse-postgresql-0

# Test database connection
kubectl exec -n langfuse langfuse-postgresql-0 -- psql -U postgres -c '\l'
```

**Check ClickHouse pod:**
```bash
kubectl logs -n langfuse -l app.kubernetes.io/name=clickhouse

# Test ClickHouse connection
kubectl exec -n langfuse <clickhouse-pod> -- clickhouse-client -q "SHOW DATABASES"
```

### Issue: Helm installation fails

**Check Helm version:**
```bash
helm version
# Requires Helm 3.x
```

**Update Helm repository:**
```bash
helm repo update
helm search repo langfuse
```

**Check existing installation:**
```bash
helm list -n langfuse

# If exists, uninstall first
helm uninstall langfuse -n langfuse
```

### Issue: Permission denied on /etc/hosts

**Manual addition:**
```bash
echo "127.0.0.1 langfuse.local" | sudo tee -a /etc/hosts
```

**Alternative - use kubectl port-forward:**
```bash
kubectl port-forward -n langfuse svc/langfuse-web 3000:3000

# Access at http://localhost:3000
# Or use the ingress at http://langfuse.local:8080 (Podman) or http://langfuse.local (Docker)
```

## OpenShift Deployment (Coming Soon)

OpenShift deployment script (`deploy-langfuse-openshift.sh`) will be added in a future update with:
- Security Context Constraints (SCC) configuration
- OpenShift Route support
- Registry and authentication considerations
- Custom SCC definitions for minimal permissions

## Next Steps

After validating the basic deployment:

1. **Security Hardening**
   - Configure TLS/HTTPS
   - Implement proper secret management
   - Network policies
   - Pod security standards

2. **Production Configuration**
   - External managed databases (RDS PostgreSQL, etc.)
   - External Redis cluster
   - External S3 storage
   - High availability (multiple replicas)
   - Auto-scaling with HPA

3. **Integration**
   - SSO/OAuth configuration
   - API key management
   - Webhook integrations
   - Custom authentication

4. **Observability**
   - Prometheus metrics
   - Alerting rules
   - Log aggregation
   - Distributed tracing

## Resources

- **Langfuse Documentation**: https://langfuse.com/docs
- **Helm Chart Repository**: https://github.com/langfuse/langfuse-k8s
- **ArtifactHub**: https://artifacthub.io/packages/helm/langfuse-k8s/langfuse
- **Langfuse GitHub**: https://github.com/langfuse/langfuse
- **Langfuse Discord**: https://discord.gg/7NXusRtqYU

## Contributing

To contribute improvements to this deployment:

1. Create a feature branch
2. Make changes to deployment scripts or documentation
3. Test on both kind and OpenShift (when available)
4. Submit PR with description of changes

## License

This deployment configuration follows the same license as the Ambient Code Platform project. The Langfuse Helm chart and application are licensed under the MIT License.
